# H5 ç¬¬ä¸‰æ–¹ç™»å½•æ¡¥æ¥ä½¿ç”¨æŒ‡å—

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•åœ¨H5é¡µé¢ä¸­é€šè¿‡JSæ¡¥æ¥è°ƒç”¨FlutteråŸç”Ÿçš„Googleå’ŒFacebookç¬¬ä¸‰æ–¹ç™»å½•åŠŸèƒ½ã€‚

---

## ğŸ“‹ å‰ç½®æ¡ä»¶

1. **Appç«¯å·²å®Œæˆé…ç½®**ï¼šä½¿ç”¨CLIå·¥å…·å®ŒæˆGoogle/Facebooké…ç½®
2. **ç™»å½•é…ç½®å·²åˆå§‹åŒ–**ï¼šAppå¯åŠ¨æ—¶å·²è°ƒç”¨`WsdBridgeConfig.setupGoogleLogin()`å’Œ`WsdBridgeConfig.setupFacebookLogin()`
3. **H5è¿è¡Œåœ¨WebViewç¯å¢ƒ**ï¼šç¡®ä¿æ¡¥æ¥ç¯å¢ƒå¯ç”¨

---

## ğŸ” ç¯å¢ƒæ£€æµ‹

åœ¨è°ƒç”¨ç™»å½•æ–¹æ³•å‰ï¼Œå»ºè®®å…ˆæ£€æµ‹æ¡¥æ¥ç¯å¢ƒï¼š

```javascript
function checkBridgeEnv() {
  if (window.flutter_inappwebview && typeof window.flutter_inappwebview.callHandler === 'function') {
    console.log('âœ… æ¡¥æ¥ç¯å¢ƒæ­£å¸¸');
    return true;
  } else {
    console.log('âŒ æœªæ£€æµ‹åˆ°æ¡¥æ¥ç¯å¢ƒ');
    return false;
  }
}
```

---

## ğŸ”‘ Google ç™»å½•

### åŸºç¡€è°ƒç”¨
```javascript
function googleLogin() {
  if (!checkBridgeEnv()) {
    alert('æ¡¥æ¥ç¯å¢ƒä¸å¯ç”¨');
    return;
  }
  
  window.flutter_inappwebview.callHandler('googleLogin', {})
    .then(function(response) {
      console.log('Googleç™»å½•å“åº”:', response);
      
      if (response.code === 0) {
        // ç™»å½•æˆåŠŸ
        const idToken = response.data.idToken;
        if (idToken) {
          console.log('âœ… Googleç™»å½•æˆåŠŸï¼ŒidToken:', idToken);
          // å°†idTokenå‘é€åˆ°ä½ çš„åç«¯è¿›è¡ŒéªŒè¯
          sendTokenToBackend('google', idToken);
        } else {
          console.log('âŒ æœªè·å–åˆ°idToken:', response.data.msg);
          alert('ç™»å½•å¤±è´¥: ' + response.data.msg);
        }
      } else {
        console.log('âŒ æ¡¥æ¥è°ƒç”¨å¤±è´¥:', response.msg);
        alert('ç™»å½•å¤±è´¥: ' + response.msg);
      }
    })
    .catch(function(error) {
      console.error('Googleç™»å½•å¼‚å¸¸:', error);
      alert('ç™»å½•å¼‚å¸¸: ' + error);
    });
}
```

### å“åº”æ ¼å¼
```javascript
// æˆåŠŸå“åº”
{
  "code": 0,
  "data": {
    "idToken": "eyJhbGciOiJSUzI1NiIs...",  // Google ID Token
    "msg": null
  },
  "msg": "success"
}

// å¤±è´¥å“åº”
{
  "code": 0,
  "data": {
    "idToken": null,
    "msg": "ç”¨æˆ·å–æ¶ˆç™»å½•"  // æˆ–å…¶ä»–é”™è¯¯ä¿¡æ¯
  },
  "msg": "success"
}

// é…ç½®é”™è¯¯
{
  "code": 0,
  "data": {
    "idToken": null,
    "msg": "Googleç™»å½•æœªé…ç½®ï¼Œè¯·å…ˆè°ƒç”¨ WsdBridgeConfig.setupGoogleLogin()"
  },
  "msg": "success"
}
```

---

## ğŸ”µ Facebook ç™»å½•

### åŸºç¡€è°ƒç”¨
```javascript
function facebookLogin() {
  if (!checkBridgeEnv()) {
    alert('æ¡¥æ¥ç¯å¢ƒä¸å¯ç”¨');
    return;
  }
  
  window.flutter_inappwebview.callHandler('facebookLogin', {})
    .then(function(response) {
      console.log('Facebookç™»å½•å“åº”:', response);
      
      if (response.code === 0) {
        // ç™»å½•æˆåŠŸ
        const accessToken = response.data.idToken; // æ³¨æ„ï¼šFacebookè¿”å›çš„æ˜¯accessToken
        if (accessToken) {
          console.log('âœ… Facebookç™»å½•æˆåŠŸï¼ŒaccessToken:', accessToken);
          // å°†accessTokenå‘é€åˆ°ä½ çš„åç«¯è¿›è¡ŒéªŒè¯
          sendTokenToBackend('facebook', accessToken);
        } else {
          console.log('âŒ æœªè·å–åˆ°accessToken:', response.data.msg);
          alert('ç™»å½•å¤±è´¥: ' + response.data.msg);
        }
      } else {
        console.log('âŒ æ¡¥æ¥è°ƒç”¨å¤±è´¥:', response.msg);
        alert('ç™»å½•å¤±è´¥: ' + response.msg);
      }
    })
    .catch(function(error) {
      console.error('Facebookç™»å½•å¼‚å¸¸:', error);
      alert('ç™»å½•å¼‚å¸¸: ' + error);
    });
}
```

### å“åº”æ ¼å¼
```javascript
// æˆåŠŸå“åº”
{
  "code": 0,
  "data": {
    "idToken": "EAABwzLixnjYBOZC...",  // Facebook Access Token
    "msg": null
  },
  "msg": "success"
}

// å¤±è´¥å“åº”
{
  "code": 0,
  "data": {
    "idToken": null,
    "msg": "ç”¨æˆ·å–æ¶ˆç™»å½•"  // æˆ–å…¶ä»–é”™è¯¯ä¿¡æ¯
  },
  "msg": "success"
}
```

---

## ğŸ”§ å®Œæ•´ç¤ºä¾‹é¡µé¢

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç¬¬ä¸‰æ–¹ç™»å½•æµ‹è¯•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { 
      padding: 12px 24px; 
      margin: 8px; 
      border: none; 
      border-radius: 6px; 
      font-size: 16px; 
      cursor: pointer; 
    }
    .google-btn { background: #4285f4; color: white; }
    .facebook-btn { background: #1877f2; color: white; }
    .result { 
      margin-top: 16px; 
      padding: 12px; 
      border-radius: 4px; 
      background: #f5f5f5; 
      font-family: monospace; 
    }
  </style>
</head>
<body>
  <h1>ğŸ” ç¬¬ä¸‰æ–¹ç™»å½•æµ‹è¯•</h1>
  
  <div>
    <button class="google-btn" onclick="googleLogin()">ğŸ”‘ Google ç™»å½•</button>
    <button class="facebook-btn" onclick="facebookLogin()">ğŸ”µ Facebook ç™»å½•</button>
  </div>
  
  <div id="result" class="result">ç­‰å¾…ç™»å½•...</div>

  <script>
    // ç¯å¢ƒæ£€æµ‹
    function checkBridgeEnv() {
      return window.flutter_inappwebview && 
             typeof window.flutter_inappwebview.callHandler === 'function';
    }

    // æ˜¾ç¤ºç»“æœ
    function showResult(title, data) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `
        <strong>${title}</strong><br>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `;
    }

    // Google ç™»å½•
    function googleLogin() {
      if (!checkBridgeEnv()) {
        showResult('âŒ ç¯å¢ƒé”™è¯¯', { error: 'æ¡¥æ¥ç¯å¢ƒä¸å¯ç”¨' });
        return;
      }
      
      showResult('ğŸ”„ æ­£åœ¨ç™»å½•...', { platform: 'Google' });
      
      window.flutter_inappwebview.callHandler('googleLogin', {})
        .then(function(response) {
          if (response.code === 0 && response.data.idToken) {
            showResult('âœ… Google ç™»å½•æˆåŠŸ', {
              platform: 'Google',
              idToken: response.data.idToken.substring(0, 50) + '...',
              fullToken: response.data.idToken
            });
            // è¿™é‡Œå¯ä»¥å°† token å‘é€åˆ°åç«¯
            // sendTokenToBackend('google', response.data.idToken);
          } else {
            showResult('âŒ Google ç™»å½•å¤±è´¥', response.data);
          }
        })
        .catch(function(error) {
          showResult('âŒ Google ç™»å½•å¼‚å¸¸', { error: error.toString() });
        });
    }

    // Facebook ç™»å½•
    function facebookLogin() {
      if (!checkBridgeEnv()) {
        showResult('âŒ ç¯å¢ƒé”™è¯¯', { error: 'æ¡¥æ¥ç¯å¢ƒä¸å¯ç”¨' });
        return;
      }
      
      showResult('ğŸ”„ æ­£åœ¨ç™»å½•...', { platform: 'Facebook' });
      
      window.flutter_inappwebview.callHandler('facebookLogin', {})
        .then(function(response) {
          if (response.code === 0 && response.data.idToken) {
            showResult('âœ… Facebook ç™»å½•æˆåŠŸ', {
              platform: 'Facebook',
              accessToken: response.data.idToken.substring(0, 50) + '...',
              fullToken: response.data.idToken
            });
            // è¿™é‡Œå¯ä»¥å°† token å‘é€åˆ°åç«¯
            // sendTokenToBackend('facebook', response.data.idToken);
          } else {
            showResult('âŒ Facebook ç™»å½•å¤±è´¥', response.data);
          }
        })
        .catch(function(error) {
          showResult('âŒ Facebook ç™»å½•å¼‚å¸¸', { error: error.toString() });
        });
    }

    // å‘é€ token åˆ°åç«¯ï¼ˆç¤ºä¾‹ï¼‰
    function sendTokenToBackend(platform, token) {
      // å®é™…é¡¹ç›®ä¸­çš„åç«¯APIè°ƒç”¨
      console.log(`å‡†å¤‡å‘é€ ${platform} token åˆ°åç«¯:`, token);
      
      // ç¤ºä¾‹ï¼šä½¿ç”¨ fetch å‘é€åˆ°åç«¯
      /*
      fetch('/api/auth/social-login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          platform: platform,
          token: token
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('åç«¯å“åº”:', data);
        // å¤„ç†ç™»å½•æˆåŠŸåçš„é€»è¾‘
      })
      .catch(error => {
        console.error('åç«¯è°ƒç”¨å¤±è´¥:', error);
      });
      */
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ£€æµ‹ç¯å¢ƒ
    window.onload = function() {
      if (checkBridgeEnv()) {
        showResult('âœ… ç¯å¢ƒæ£€æµ‹', { status: 'æ¡¥æ¥ç¯å¢ƒæ­£å¸¸ï¼Œå¯ä»¥ä½¿ç”¨ç™»å½•åŠŸèƒ½' });
      } else {
        showResult('âŒ ç¯å¢ƒæ£€æµ‹', { 
          status: 'æ¡¥æ¥ç¯å¢ƒä¸å¯ç”¨', 
          note: 'è¯·åœ¨Appçš„WebViewä¸­æ‰“å¼€æ­¤é¡µé¢' 
        });
      }
    };
  </script>
</body>
</html>
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. **Tokenç±»å‹åŒºåˆ«**
- **Google**: è¿”å› `idToken`ï¼ˆJWTæ ¼å¼ï¼‰ï¼Œç”¨äºåç«¯éªŒè¯ç”¨æˆ·èº«ä»½
- **Facebook**: è¿”å› `accessToken`ï¼ˆå­—ç¬¦ä¸²æ ¼å¼ï¼‰ï¼Œç”¨äºè°ƒç”¨Facebook API

### 2. **é”™è¯¯å¤„ç†**
- ç”¨æˆ·å–æ¶ˆç™»å½•ï¼š`response.data.msg === "ç”¨æˆ·å–æ¶ˆç™»å½•"`
- é…ç½®é”™è¯¯ï¼š`response.data.msg` åŒ…å«å…·ä½“é”™è¯¯ä¿¡æ¯
- ç½‘ç»œå¼‚å¸¸ï¼šé€šè¿‡ `.catch()` æ•è·

### 3. **å®‰å…¨å»ºè®®**
- æ°¸è¿œä¸è¦åœ¨å‰ç«¯å­˜å‚¨æ•æ„Ÿçš„tokenä¿¡æ¯
- ç«‹å³å°†tokenå‘é€åˆ°åç«¯è¿›è¡ŒéªŒè¯å’Œäº¤æ¢
- å®æ–½åˆé€‚çš„tokenè¿‡æœŸå’Œåˆ·æ–°æœºåˆ¶

### 4. **è°ƒè¯•æŠ€å·§**
- ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
- å¯ä»¥ä½¿ç”¨ `example/web/bridge_test.html` è¿›è¡Œå®Œæ•´æµ‹è¯•
- æ£€æŸ¥Appç«¯æ—¥å¿—è¾“å‡ºæ¥å®šä½é—®é¢˜

---

## ğŸš€ åç»­æ­¥éª¤

1. **é›†æˆåˆ°ä½ çš„H5é¡¹ç›®**ï¼šå°†ä¸Šè¿°ä»£ç é›†æˆåˆ°å®é™…çš„H5é¡µé¢ä¸­
2. **åç«¯TokenéªŒè¯**ï¼šå®ç°åç«¯æ¥å£æ¥éªŒè¯Google/Facebook token
3. **ç”¨æˆ·çŠ¶æ€ç®¡ç†**ï¼šåœ¨H5ä¸­ç»´æŠ¤ç™»å½•çŠ¶æ€ï¼Œæ”¯æŒè‡ªåŠ¨ç™»å½•ç­‰åŠŸèƒ½
4. **é”™è¯¯å¤„ç†ä¼˜åŒ–**ï¼šæ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚å®Œå–„é”™è¯¯å¤„ç†é€»è¾‘

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. æŸ¥çœ‹Appç«¯æ—¥å¿—è¾“å‡ºï¼ˆæœç´¢ `[JSBridge]` å…³é”®å­—ï¼‰
2. ä½¿ç”¨ `example/web/bridge_test.html` è¿›è¡Œå¯¹æ¯”æµ‹è¯•
3. æ£€æŸ¥ç¬¬ä¸‰æ–¹ç™»å½•çš„åŸç”Ÿé…ç½®æ˜¯å¦æ­£ç¡®
4. ç¡®è®¤ `WsdBridgeConfig` çš„åˆå§‹åŒ–æ˜¯å¦æˆåŠŸ 