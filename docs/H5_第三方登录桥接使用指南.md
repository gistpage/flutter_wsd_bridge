# H5 第三方登录桥接使用指南

本指南介绍如何在H5页面中通过JS桥接调用Flutter原生的Google和Facebook第三方登录功能。

---

## 📋 前置条件

1. **App端已完成配置**：使用CLI工具完成Google/Facebook配置
2. **登录配置已初始化**：App启动时已调用`WsdBridgeConfig.setupGoogleLogin()`和`WsdBridgeConfig.setupFacebookLogin()`
3. **H5运行在WebView环境**：确保桥接环境可用

---

## 🔍 环境检测

在调用登录方法前，建议先检测桥接环境：

```javascript
function checkBridgeEnv() {
  if (window.flutter_inappwebview && typeof window.flutter_inappwebview.callHandler === 'function') {
    console.log('✅ 桥接环境正常');
    return true;
  } else {
    console.log('❌ 未检测到桥接环境');
    return false;
  }
}
```

---

## 🔑 Google 登录

### 基础调用
```javascript
function googleLogin() {
  if (!checkBridgeEnv()) {
    alert('桥接环境不可用');
    return;
  }
  
  window.flutter_inappwebview.callHandler('googleLogin', {})
    .then(function(response) {
      console.log('Google登录响应:', response);
      
      if (response.code === 0) {
        // 登录成功
        const idToken = response.data.idToken;
        if (idToken) {
          console.log('✅ Google登录成功，idToken:', idToken);
          // 将idToken发送到你的后端进行验证
          sendTokenToBackend('google', idToken);
        } else {
          console.log('❌ 未获取到idToken:', response.data.msg);
          alert('登录失败: ' + response.data.msg);
        }
      } else {
        console.log('❌ 桥接调用失败:', response.msg);
        alert('登录失败: ' + response.msg);
      }
    })
    .catch(function(error) {
      console.error('Google登录异常:', error);
      alert('登录异常: ' + error);
    });
}
```

### 响应格式
```javascript
// 成功响应
{
  "code": 0,
  "data": {
    "idToken": "eyJhbGciOiJSUzI1NiIs...",  // Google ID Token
    "msg": null
  },
  "msg": "success"
}

// 失败响应
{
  "code": 0,
  "data": {
    "idToken": null,
    "msg": "用户取消登录"  // 或其他错误信息
  },
  "msg": "success"
}

// 配置错误
{
  "code": 0,
  "data": {
    "idToken": null,
    "msg": "Google登录未配置，请先调用 WsdBridgeConfig.setupGoogleLogin()"
  },
  "msg": "success"
}
```

---

## 🔵 Facebook 登录

### 基础调用
```javascript
function facebookLogin() {
  if (!checkBridgeEnv()) {
    alert('桥接环境不可用');
    return;
  }
  
  window.flutter_inappwebview.callHandler('facebookLogin', {})
    .then(function(response) {
      console.log('Facebook登录响应:', response);
      
      if (response.code === 0) {
        // 登录成功
        const accessToken = response.data.idToken; // 注意：Facebook返回的是accessToken
        if (accessToken) {
          console.log('✅ Facebook登录成功，accessToken:', accessToken);
          // 将accessToken发送到你的后端进行验证
          sendTokenToBackend('facebook', accessToken);
        } else {
          console.log('❌ 未获取到accessToken:', response.data.msg);
          alert('登录失败: ' + response.data.msg);
        }
      } else {
        console.log('❌ 桥接调用失败:', response.msg);
        alert('登录失败: ' + response.msg);
      }
    })
    .catch(function(error) {
      console.error('Facebook登录异常:', error);
      alert('登录异常: ' + error);
    });
}
```

### 响应格式
```javascript
// 成功响应
{
  "code": 0,
  "data": {
    "idToken": "EAABwzLixnjYBOZC...",  // Facebook Access Token
    "msg": null
  },
  "msg": "success"
}

// 失败响应
{
  "code": 0,
  "data": {
    "idToken": null,
    "msg": "用户取消登录"  // 或其他错误信息
  },
  "msg": "success"
}
```

---

## 🔧 完整示例页面

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>第三方登录测试</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { 
      padding: 12px 24px; 
      margin: 8px; 
      border: none; 
      border-radius: 6px; 
      font-size: 16px; 
      cursor: pointer; 
    }
    .google-btn { background: #4285f4; color: white; }
    .facebook-btn { background: #1877f2; color: white; }
    .result { 
      margin-top: 16px; 
      padding: 12px; 
      border-radius: 4px; 
      background: #f5f5f5; 
      font-family: monospace; 
    }
  </style>
</head>
<body>
  <h1>🔐 第三方登录测试</h1>
  
  <div>
    <button class="google-btn" onclick="googleLogin()">🔑 Google 登录</button>
    <button class="facebook-btn" onclick="facebookLogin()">🔵 Facebook 登录</button>
  </div>
  
  <div id="result" class="result">等待登录...</div>

  <script>
    // 环境检测
    function checkBridgeEnv() {
      return window.flutter_inappwebview && 
             typeof window.flutter_inappwebview.callHandler === 'function';
    }

    // 显示结果
    function showResult(title, data) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `
        <strong>${title}</strong><br>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `;
    }

    // Google 登录
    function googleLogin() {
      if (!checkBridgeEnv()) {
        showResult('❌ 环境错误', { error: '桥接环境不可用' });
        return;
      }
      
      showResult('🔄 正在登录...', { platform: 'Google' });
      
      window.flutter_inappwebview.callHandler('googleLogin', {})
        .then(function(response) {
          if (response.code === 0 && response.data.idToken) {
            showResult('✅ Google 登录成功', {
              platform: 'Google',
              idToken: response.data.idToken.substring(0, 50) + '...',
              fullToken: response.data.idToken
            });
            // 这里可以将 token 发送到后端
            // sendTokenToBackend('google', response.data.idToken);
          } else {
            showResult('❌ Google 登录失败', response.data);
          }
        })
        .catch(function(error) {
          showResult('❌ Google 登录异常', { error: error.toString() });
        });
    }

    // Facebook 登录
    function facebookLogin() {
      if (!checkBridgeEnv()) {
        showResult('❌ 环境错误', { error: '桥接环境不可用' });
        return;
      }
      
      showResult('🔄 正在登录...', { platform: 'Facebook' });
      
      window.flutter_inappwebview.callHandler('facebookLogin', {})
        .then(function(response) {
          if (response.code === 0 && response.data.idToken) {
            showResult('✅ Facebook 登录成功', {
              platform: 'Facebook',
              accessToken: response.data.idToken.substring(0, 50) + '...',
              fullToken: response.data.idToken
            });
            // 这里可以将 token 发送到后端
            // sendTokenToBackend('facebook', response.data.idToken);
          } else {
            showResult('❌ Facebook 登录失败', response.data);
          }
        })
        .catch(function(error) {
          showResult('❌ Facebook 登录异常', { error: error.toString() });
        });
    }

    // 发送 token 到后端（示例）
    function sendTokenToBackend(platform, token) {
      // 实际项目中的后端API调用
      console.log(`准备发送 ${platform} token 到后端:`, token);
      
      // 示例：使用 fetch 发送到后端
      /*
      fetch('/api/auth/social-login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          platform: platform,
          token: token
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('后端响应:', data);
        // 处理登录成功后的逻辑
      })
      .catch(error => {
        console.error('后端调用失败:', error);
      });
      */
    }

    // 页面加载完成后检测环境
    window.onload = function() {
      if (checkBridgeEnv()) {
        showResult('✅ 环境检测', { status: '桥接环境正常，可以使用登录功能' });
      } else {
        showResult('❌ 环境检测', { 
          status: '桥接环境不可用', 
          note: '请在App的WebView中打开此页面' 
        });
      }
    };
  </script>
</body>
</html>
```

---

## ⚠️ 注意事项

### 1. **Token类型区别**
- **Google**: 返回 `idToken`（JWT格式），用于后端验证用户身份
- **Facebook**: 返回 `accessToken`（字符串格式），用于调用Facebook API

### 2. **错误处理**
- 用户取消登录：`response.data.msg === "用户取消登录"`
- 配置错误：`response.data.msg` 包含具体错误信息
- 网络异常：通过 `.catch()` 捕获

### 3. **安全建议**
- 永远不要在前端存储敏感的token信息
- 立即将token发送到后端进行验证和交换
- 实施合适的token过期和刷新机制

### 4. **调试技巧**
- 使用浏览器开发者工具查看控制台输出
- 可以使用 `example/web/bridge_test.html` 进行完整测试
- 检查App端日志输出来定位问题

---

## 🚀 后续步骤

1. **集成到你的H5项目**：将上述代码集成到实际的H5页面中
2. **后端Token验证**：实现后端接口来验证Google/Facebook token
3. **用户状态管理**：在H5中维护登录状态，支持自动登录等功能
4. **错误处理优化**：根据实际业务需求完善错误处理逻辑

---

## 📞 技术支持

如遇到问题，可以：
1. 查看App端日志输出（搜索 `[JSBridge]` 关键字）
2. 使用 `example/web/bridge_test.html` 进行对比测试
3. 检查第三方登录的原生配置是否正确
4. 确认 `WsdBridgeConfig` 的初始化是否成功 