<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>WSD Bridge H5 测试</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f4f6fa; }
    .banner {
      background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
      color: #fff;
      padding: 32px 20px 20px 20px;
      text-align: center;
      border-bottom-left-radius: 32px;
      border-bottom-right-radius: 32px;
      box-shadow: 0 2px 8px rgba(106,17,203,0.08);
    }
    .banner h1 { margin: 0 0 8px 0; font-size: 2.2em; letter-spacing: 2px; }
    .banner p { margin: 0; font-size: 1.1em; opacity: 0.92; }
    .env-status {
      margin: 18px auto 0 auto; max-width: 520px; padding: 10px 0; font-size: 1.1em; font-weight: bold;
      border-radius: 8px; text-align: center;
    }
    .env-ok { background: #e6ffed; color: #237804; border: 1px solid #b7eb8f; }
    .env-fail { background: #fff1f0; color: #cf1322; border: 1px solid #ffa39e; }
    .section {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 22px 18px 18px 18px;
      margin: 28px auto 0 auto;
      max-width: 520px;
      border-left: 6px solid #6a11cb;
      position: relative;
    }
    .section h2 {
      color: #2575fc;
      margin-top: 0;
      font-size: 1.25em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section .icon {
      font-size: 1.3em;
      margin-right: 4px;
    }
    label { display: block; margin-top: 8px; font-weight: 500; }
    input, textarea {
      width: 100%; margin-top: 4px; margin-bottom: 8px; border-radius: 6px; border: 1px solid #d0d7e2; padding: 7px 10px; font-size: 1em;
      background: #f8fafd;
    }
    button {
      margin-top: 8px; padding: 10px 0; width: 100%; border: none; border-radius: 6px; font-size: 1.1em; font-weight: bold;
      background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%); color: #fff; cursor: pointer; box-shadow: 0 1px 4px rgba(106,17,203,0.08);
      transition: background 0.2s;
    }
    button:hover { background: linear-gradient(90deg, #2575fc 0%, #6a11cb 100%); }
    .result-box {
      background: #f0f7ff;
      color: #1a237e;
      border-radius: 6px;
      border: 1px solid #b3c6e6;
      margin-top: 8px;
      padding: 8px 10px;
      font-size: 15px;
      min-height: 22px;
      font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
      word-break: break-all;
    }
    .tip {
      background: #fffbe6; color: #b8860b; border-left: 5px solid #ffe066; padding: 10px 14px; border-radius: 8px; margin: 18px auto 0 auto; max-width: 520px;
      font-size: 1em; font-weight: 500;
    }
    @media (max-width: 600px) {
      .section, .tip, .env-status { max-width: 98vw; }
      .banner { padding: 24px 4vw 14px 4vw; }
    }
  </style>
</head>
<body>
  <div class="banner">
    <h1>🧪 WSD Bridge H5 测试</h1>
    <p>一站式验证 <b>JSBridge</b> 与原生桥接能力，支持 eventTracker、openWebView、参数校验、回调等全流程。<br>请在 App WebView 中访问本页，所有结果实时高亮展示。</p>
  </div>

  <div id="pageTimestamp" class="env-status" style="background:#fffbe6;color:#b8860b;border:1px solid #ffe066;margin-top:8px;">页面加载时间戳：<span id="timestampValue"></span></div>

  <div id="envStatus" class="env-status">环境检测中...</div>

  <div class="section">
    <h2><span class="icon">📊</span>1. eventTracker 测试</h2>
    <label>eventName:</label>
    <input id="eventTrackerName" value="test_event" />
    <label>eventValue (JSON):</label>
    <textarea id="eventTrackerValue">{"foo": "bar"}</textarea>
    <button onclick="callEventTracker()">🚀 调用 eventTracker</button>
    <div id="result-eventTracker" class="result-box"></div>
    <button onclick="copyResult('result-eventTracker')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🌐</span>2. openWebView 测试</h2>
    <label>url:</label>
    <input id="openWebViewUrl" value="https://flutter.dev" />
    <label>type (1=外跳, 2=内嵌):</label>
    <input id="openWebViewType" value="2" />
    <button onclick="callOpenWebView(2, 'https://www.example.com')">测试内跳（type=2）</button>
    <button onclick="callOpenWebView(1, 'https://www.example.com')">测试外跳（type=1）</button>
    <div id="resultBox" style="margin-top:20px;"></div>
    <button onclick="copyResult('resultBox')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🌍</span>3. openAndroid 测试</h2>
    <label>url:</label>
    <input id="openAndroidUrl" value="https://www.baidu.com" />
    <button onclick="callOpenAndroid()">🔗 调用 openAndroid</button>
    <div id="result-openAndroid" class="result-box"></div>
    <button onclick="copyResult('result-openAndroid')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">❌</span>4. closeWebView 测试</h2>
    <button onclick="callCloseWebView()">🛑 调用 closeWebView</button>
    <div id="result-closeWebView" class="result-box"></div>
    <button onclick="copyResult('result-closeWebView')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
    <div style="text-align:center;margin:16px 0;">
      <button onclick="openChildTestPage()" style="width:auto;padding:8px 24px;font-size:1em;">打开二级测试页（新标签页）</button>
    </div>
  </div>

  <div class="section">
    <h2><span class="icon">🧑‍💻</span>5. getUseragent 测试</h2>
    <button onclick="callGetUseragent()">🔍 获取 useragent</button>
    <div id="result-getUseragent" class="result-box"></div>
    <button onclick="copyResult('result-getUseragent')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🔑</span>6. googleLogin 测试</h2>
    <button onclick="callGoogleLogin()">🔑 调用 googleLogin</button>
    <div id="result-googleLogin" class="result-box"></div>
    <button onclick="copyResult('result-googleLogin')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🔵</span>7. facebookLogin 测试</h2>
    <button onclick="callFacebookLogin()">🔵 调用 facebookLogin</button>
    <div id="result-facebookLogin" class="result-box"></div>
    <button onclick="copyResult('result-facebookLogin')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">📬</span>8. getFcmToken 测试</h2>
    <button onclick="callGetFcmToken()">📬 调用 getFcmToken</button>
    <div id="result-getFcmToken" class="result-box"></div>
    <button onclick="copyResult('result-getFcmToken')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">⚠️</span>9. alert 测试</h2>
    <label>message:</label>
    <input id="alertMsg" value="Hello from H5!" />
    <button onclick="callAlert()">⚠️ 调用 alert</button>
    <div id="result-alert" class="result-box"></div>
    <button onclick="copyResult('result-alert')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🌐</span>10. openWindow 测试</h2>
    <label>url:</label>
    <input id="openWindowUrl" value="https://www.baidu.com" />
    <button onclick="callOpenWindow()">🌐 调用 openWindow</button>
    <div id="result-openWindow" class="result-box"></div>
    <button onclick="copyResult('result-openWindow')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="section">
    <h2><span class="icon">🔗</span>11. handleHtmlLink 测试</h2>
    <label>url:</label>
    <input id="handleHtmlLinkUrl" value="https://www.baidu.com" />
    <button onclick="callHandleHtmlLink()">🔗 调用 handleHtmlLink</button>
    <div id="result-handleHtmlLink" class="result-box"></div>
    <button onclick="copyResult('result-handleHtmlLink')" style="margin-top:4px;background:#e6f7ff;color:#1890ff;">复制结果</button>
  </div>

  <div class="tip">⚡ <b>提示：</b>如需本地联调，请用 <b>http://localhost:8080/bridge_test.html</b> 作为 WebView 地址。</div>

  <!-- ========== 原生JS能力桥接测试 ========== -->
  <div class="section">
    <h2><span class="icon">🧩</span>12. 原生JS能力桥接测试</h2>
    <label>window.alert 测试</label>
    <input id="jsAlertMsg" value="Hello from window.alert!" />
    <button onclick="testJsAlert()">🟣 调用 window.alert</button>
    <div id="result-jsAlert" class="result-box"></div>

    <label style="margin-top:16px;">window.confirm 测试</label>
    <input id="jsConfirmMsg" value="Are you sure?" />
    <button onclick="testJsConfirm()">🟢 调用 window.confirm</button>
    <div id="result-jsConfirm" class="result-box"></div>

    <label style="margin-top:16px;">window.prompt 测试</label>
    <input id="jsPromptMsg" value="请输入内容" />
    <input id="jsPromptDefault" value="默认值" />
    <button onclick="testJsPrompt()">🟠 调用 window.prompt</button>
    <div id="result-jsPrompt" class="result-box"></div>

    <label style="margin-top:16px;">window.open 测试</label>
    <input id="jsOpenUrl" value="https://flutter.dev" />
    <button onclick="testJsOpen()">🔵 调用 window.open</button>
    <div id="result-jsOpen" class="result-box"></div>

    <label style="margin-top:16px;">a标签超链接测试</label>
    <input id="jsALink" value="https://www.baidu.com" />
    <a id="testALink" href="https://www.baidu.com" target="_blank" style="display:inline-block;margin-top:8px;color:#2575fc;text-decoration:underline;">点击跳转 a 标签</a>
    <div id="result-jsALink" class="result-box"></div>
  </div>

  <script>
    console.log('H5 JS loaded at', new Date());

    // 环境检测
    function checkBridgeEnv() {
      var envStatus = document.getElementById('envStatus');
      if (window.flutter_inappwebview && typeof window.flutter_inappwebview.callHandler === 'function') {
        envStatus.textContent = '✅ 已检测到桥接环境，可正常调用';
        envStatus.className = 'env-status env-ok';
        return true;
      } else {
        envStatus.textContent = '❌ 未检测到桥接环境，请在App内WebView中打开';
        envStatus.className = 'env-status env-fail';
        return false;
      }
    }
    checkBridgeEnv();

    // eventTracker 测试
    function callEventTracker() {
      if (!checkBridgeEnv()) {
        showResult('result-eventTracker', 'eventTracker', {}, '[未检测到桥接环境]');
        return;
      }
      let eventName = document.getElementById('eventTrackerName').value;
      let eventValue = safeParse(document.getElementById('eventTrackerValue').value);
      if (!eventName || !eventValue) return;
      window.flutter_inappwebview.callHandler('eventTracker', { eventName, eventValue })
        .then(function(result) {
          showResult('result-eventTracker', 'eventTracker', { eventName, eventValue }, result);
        })
        .catch(function(err) {
          showResult('result-eventTracker', 'eventTracker', { eventName, eventValue }, '[异常] ' + err);
        });
    }

    // openWebView 测试
    function callOpenWebView(type, url) {
      const params = { type, url };
      if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
        window.flutter_inappwebview.callHandler('openWebView', params).then(function(result) {
          console.log('openWebView result:', result);
          showResult('resultBox', 'openWebView', params, result);
          if (!result) {
            alert('插件返回结果为 null，请检查插件端 openWebView handler 的返回值！');
            return;
          }
          if (result.code === 0 && result.data && result.data.type && result.data.url) {
            if (result.data.type === 2) {
              window.location.href = result.data.url;
            } else if (result.data.type === 1) {
              window.open(result.data.url, '_blank');
            }
          }
        });
      } else {
        showResult('resultBox', 'openWebView', params, { code: -1, msg: '未检测到 flutter_inappwebview 环境', data: null });
      }
    }

    // openAndroid 测试
    function callOpenAndroid() {
      if (!checkBridgeEnv()) {
        showResult('result-openAndroid', 'openAndroid', {}, '[未检测到桥接环境]');
        return;
      }
      let url = document.getElementById('openAndroidUrl').value;
      window.flutter_inappwebview.callHandler('openAndroid', { url })
        .then(function(result) {
          showResult('result-openAndroid', 'openAndroid', { url }, result);
        })
        .catch(function(err) {
          showResult('result-openAndroid', 'openAndroid', { url }, '[异常] ' + err);
        });
    }

    // closeWebView 测试
    function callCloseWebView() {
      if (!checkBridgeEnv()) {
        showResult('result-closeWebView', 'closeWebView', {}, '[未检测到桥接环境]');
        return;
      }
      window.flutter_inappwebview.callHandler('closeWebView', {})
        .then(function(result) {
          showResult('result-closeWebView', 'closeWebView', {}, result);
          // 仅在二级页面自动关闭
          if (isChildPage() && result && result.code === 0 && result.data && result.data.closed === true) {
            window.close();
            // 兜底：关闭失败时返回上一页
            setTimeout(function() {
              if (!window.closed) {
                window.history.back();
              }
            }, 300);
          }
        })
        .catch(function(err) {
          showResult('result-closeWebView', 'closeWebView', {}, '[异常] ' + err);
        });
    }

    // getUseragent 测试
    function callGetUseragent() {
      if (!checkBridgeEnv()) {
        showResult('result-getUseragent', 'getUseragent', {}, '[未检测到桥接环境]');
        return;
      }
      window.flutter_inappwebview.callHandler('getUseragent', {})
        .then(function(result) {
          showResult('result-getUseragent', 'getUseragent', {}, result);
        })
        .catch(function(err) {
          showResult('result-getUseragent', 'getUseragent', {}, '[异常] ' + err);
        });
    }

    // googleLogin 测试
    function callGoogleLogin() {
      if (!checkBridgeEnv()) {
        showResult('result-googleLogin', 'googleLogin', {}, '[未检测到桥接环境]');
        return;
      }
      window.flutter_inappwebview.callHandler('googleLogin', {})
        .then(function(result) {
          showResult('result-googleLogin', 'googleLogin', {}, result);
        })
        .catch(function(err) {
          showResult('result-googleLogin', 'googleLogin', {}, '[异常] ' + err);
        });
    }

    // facebookLogin 测试
    function callFacebookLogin() {
      if (!checkBridgeEnv()) {
        showResult('result-facebookLogin', 'facebookLogin', {}, '[未检测到桥接环境]');
        return;
      }
      window.flutter_inappwebview.callHandler('facebookLogin', {})
        .then(function(result) {
          showResult('result-facebookLogin', 'facebookLogin', {}, result);
        })
        .catch(function(err) {
          showResult('result-facebookLogin', 'facebookLogin', {}, '[异常] ' + err);
        });
    }

    // getFcmToken 测试
    function callGetFcmToken() {
      if (!checkBridgeEnv()) {
        showResult('result-getFcmToken', 'getFcmToken', {}, '[未检测到桥接环境]');
        return;
      }
      window.flutter_inappwebview.callHandler('getFcmToken', {})
        .then(function(result) {
          showResult('result-getFcmToken', 'getFcmToken', {}, result);
        })
        .catch(function(err) {
          showResult('result-getFcmToken', 'getFcmToken', {}, '[异常] ' + err);
        });
    }

    // alert 测试
    function callAlert() {
      if (!checkBridgeEnv()) {
        showResult('result-alert', 'alert', {}, '[未检测到桥接环境]');
        return;
      }
      let message = document.getElementById('alertMsg').value;
      window.flutter_inappwebview.callHandler('alert', { message })
        .then(function(result) {
          showResult('result-alert', 'alert', { message }, result);
        })
        .catch(function(err) {
          showResult('result-alert', 'alert', { message }, '[异常] ' + err);
        });
    }

    // openWindow 测试
    function callOpenWindow() {
      if (!checkBridgeEnv()) {
        showResult('result-openWindow', 'openWindow', {}, '[未检测到桥接环境]');
        return;
      }
      let url = document.getElementById('openWindowUrl').value;
      window.flutter_inappwebview.callHandler('openWindow', { url })
        .then(function(result) {
          showResult('result-openWindow', 'openWindow', { url }, result);
        })
        .catch(function(err) {
          showResult('result-openWindow', 'openWindow', { url }, '[异常] ' + err);
        });
    }

    // handleHtmlLink 测试
    function callHandleHtmlLink() {
      if (!checkBridgeEnv()) {
        showResult('result-handleHtmlLink', 'handleHtmlLink', {}, '[未检测到桥接环境]');
        return;
      }
      let url = document.getElementById('handleHtmlLinkUrl').value;
      window.flutter_inappwebview.callHandler('handleHtmlLink', { url })
        .then(function(result) {
          showResult('result-handleHtmlLink', 'handleHtmlLink', { url }, result);
        })
        .catch(function(err) {
          showResult('result-handleHtmlLink', 'handleHtmlLink', { url }, '[异常] ' + err);
        });
    }

    function showResult(boxId, method, params, result) {
      let box = document.getElementById(boxId);
      let msg = `[${new Date().toLocaleTimeString()}] 方法: ${method}\n参数: ${JSON.stringify(params)}\n原始结果: ${JSON.stringify(result)}`;
      box.innerHTML = `<span style='color:#2575fc;'>${msg.replace(/\n/g,'<br>')}</span>`;
    }

    // JSON安全解析
    function safeParse(str) {
      try {
        return JSON.parse(str);
      } catch (e) {
        alert('参数不是合法JSON');
        return null;
      }
    }

    function copyResult(boxId) {
      var box = document.getElementById(boxId);
      var text = box.innerText || box.textContent;
      if (!text) return;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(function() {
          alert('结果已复制到剪贴板');
        });
      } else {
        // 兼容旧浏览器
        var textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('结果已复制到剪贴板');
      }
    }

    // 显示当前时间戳，便于判断页面是否被缓存
    document.getElementById('timestampValue').textContent = Date.now();

    // 打开二级测试页
    function openChildTestPage() {
      window.open(window.location.pathname + '?scene=child', '_blank');
    }

    // 判断是否为二级测试页
    function isChildPage() {
      return /[?&]scene=child/.test(window.location.search);
    }

    function testJsAlert() {
      let msg = document.getElementById('jsAlertMsg').value;
      let t0 = Date.now();
      alert(msg);
      let t1 = Date.now();
      document.getElementById('result-jsAlert').innerHTML =
        `<span style='color:#2575fc;'>alert弹窗已调用，耗时${t1-t0}ms</span>`;
    }

    function testJsConfirm() {
      let msg = document.getElementById('jsConfirmMsg').value;
      let t0 = Date.now();
      let result = confirm(msg);
      let t1 = Date.now();
      document.getElementById('result-jsConfirm').innerHTML =
        `<span style='color:#2575fc;'>confirm弹窗结果: <b>${result}</b>，耗时${t1-t0}ms</span>`;
    }

    function testJsPrompt() {
      let msg = document.getElementById('jsPromptMsg').value;
      let def = document.getElementById('jsPromptDefault').value;
      let t0 = Date.now();
      let result = prompt(msg, def);
      let t1 = Date.now();
      document.getElementById('result-jsPrompt').innerHTML =
        `<span style='color:#2575fc;'>prompt弹窗结果: <b>${result}</b>，耗时${t1-t0}ms</span>`;
    }

    function testJsOpen() {
      let url = document.getElementById('jsOpenUrl').value;
      let t0 = Date.now();
      window.open(url, '_blank');
      let t1 = Date.now();
      document.getElementById('result-jsOpen').innerHTML =
        `<span style='color:#2575fc;'>window.open已调用，耗时${t1-t0}ms</span>`;
    }

    // 动态绑定a标签href
    document.getElementById('jsALink').addEventListener('input', function() {
      document.getElementById('testALink').href = this.value;
    });
    document.getElementById('testALink').addEventListener('click', function() {
      document.getElementById('result-jsALink').innerHTML =
        `<span style='color:#2575fc;'>a标签已点击，目标: ${this.href}</span>`;
    });
  </script>
</body>
</html> 